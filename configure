#!/usr/bin/env python

# Configure script for LAIK:
# - tests for required/wanted packages
# - generates a Makefile.config

import sys, getopt
import os

defs = ""
cc = ""
subdirs = "examples"
predirs = ""
ipath = "/usr/include"

# Mosquitto/MQTT
mqtt_found = os.path.isfile(ipath + "/mosquitto.h")
protobuf_found = os.path.isfile(ipath + "/protobuf-c/protobuf-c.h")
if not protobuf_found:
    # on precise/trusty header is in /usr/include/google
    protobuf_found = os.path.isfile(ipath + "/google/protobuf-c/protobuf-c.h")
    if protobuf_found:
        defs += " -I/usr/include/google"

if not mqtt_found:
    print("Mosquitto include file not found. MQTT disabled.")
    print("On Ubuntu, install 'libmosquitto-dev' or 'libmosquitto0-dev' (trusty).")
if not protobuf_found:
    print("Protobuf C include file not found. MQTT disabled.")
    print("On Ubuntu, install 'libprotobuf-c-dev' or 'libprotobuf-c0-dev' (trusty).")
if mqtt_found and protobuf_found:
    print("Mosquitto/Protobuf headers found, enabled MQTT support.")
    defs += " -DUSE_MQTT"
    predirs += "external/MQTT"

# LAIK-internal MPI support
if not os.path.isfile(ipath + "/mpi/mpi.h"):
    print("MPI not found, disabled LAIK MPI backend.")
    print("On Ubuntu, install 'libopenmpi-dev'.")
else:
    print("MPI header found in " + ipath + "/mpi, enabled MPI backend, using 'mpicc'.")
    defs += " -DUSE_MPI"
    cc = "mpicc"

# write Makefile.config, will be included by Makefile
cfile = open("Makefile.config", 'w')
cfile.write("# Generated by configure\n")
cfile.write("DEFS=" + defs + "\n")
cfile.write("SUBDIRS=" + subdirs + "\n")
cfile.write("PRE=" + predirs + "\n")
if cc:
    cfile.write("CC=" + cc + "\n")
if "PREFIX" in os.environ:
    cfile.write("PREFIX=" + os.path.abspath(os.environ['PREFIX']) + "\n")
cfile.close()

print("Generated 'Makefile.config'")
